consumers:
  - username: ory
    plugins:
      basic-auth:
        username: "$ENV://ORY_WEBHOOK_BASIC_AUTH/username"
        password: "$ENV://ORY_WEBHOOK_BASIC_AUTH/password"

upstreams:
  - id: dapr-grpc
    nodes:
      "localhost:35001": 1
    scheme: grpc
    type: roundrobin

  - id: dapr-http
    scheme: http
    nodes:
      "localhost:3500": 1

# _meta: priority -1 => We need to define the plugin order manually,
# for example the cors and grpc-web plugin do not get along so well
# https://the-asf.slack.com/archives/CUC5MN17A/p1685478440334289

services:
  - id: task-svc
    upstream_id: dapr-grpc
    plugins:
      grpc-web: {}
      proxy-rewrite:
        headers:
          add:
            dapr-app-id: task-svc
  - id: auth-svc
    upstream_id: dapr-grpc
    plugins:
      grpc-web: {}
      proxy-rewrite:
        headers:
          add:
            dapr-app-id: auth-svc
  - id: user-svc
    upstream_id: dapr-grpc
    plugins:
      grpc-web: {}
      proxy-rewrite:
        headers:
          add:
            dapr-app-id: user-svc
  - id: ory-svc
    upstream_id: dapr-http
    plugins:
      cors:
        allow_origins: "**"
        allow_methods: "**"
        allow_headers: "**"
        expose_headers: "**"
        max_age: 5
        allow_credential: true
        _meta:
          priority: -1

routes:
  - id: task-svc
    uri: /task-svc/*
    service_id: task-svc
    plugins:
      cors:
        # TODO: Scope to grpc-web spec
        allow_origins: "**"
        allow_methods: "**"
        allow_headers: "**"
        expose_headers: "grpc-status,grpc-message"
        max_age: 5
        allow_credential: true
        _meta:
          priority: -1
  - id: auth-svc
    uri: /auth-svc/*
    service_id: auth-svc
    plugins:
      cors:
        # TODO: Scope to grpc-web spec
        allow_origins: "**"
        allow_methods: "**"
        allow_headers: "**"
        expose_headers: "**"
        max_age: 5
        allow_credential: true
        _meta:
          priority: -1
  - id: user-svc
    uri: /user-svc/*
    service_id: user-svc
    plugins:
      cors:
        # TODO: Scope to grpc-web spec
        allow_origins: "**"
        allow_methods: "**"
        allow_headers: "**"
        expose_headers: "grpc-status,grpc-message"
        max_age: 5
        allow_credential: true
        _meta:
          priority: -1
  - id: ory-svc-after-registration
    uri: /ory-svc/webhooks/after-registration
    service_id: ory-svc
    plugins:
      basic-auth: {}
      proxy-rewrite:
        uri: /v1.0/invoke/ory-svc/method/after_registration_webhook
  - id: ory-svc-after-settings
    uri: /ory-svc/webhooks/after-settings
    service_id: ory-svc
    plugins:
      basic-auth: {}
      proxy-rewrite:
        uri: /v1.0/invoke/ory-svc/method/after_settings_webhook
  - id: ory-svc-oauth2-consent
    uri: /ory-svc/v1.0/oauth2/consent
    service_id: ory-svc
    plugins:
      proxy-rewrite:
        uri: /v1.0/invoke/ory-svc/method/oauth2_consent
  - id: grpc
    uri: /*
    upstream_id: dapr-grpc

#END
